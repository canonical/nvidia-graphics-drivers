#!/bin/sh
# prerm script for #DRIVERNAME#
#
# Copyright (C) 2007 Mario Limonciello
# Copyright (C) 2009 Canonical Ltd
# Authors: Alberto Milone


PACKAGE_NAME=#DRIVERNAME#
CVERSION=`dpkg-query -W -f='${Version}' $PACKAGE_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`
CVERSION=${CVERSION#*really.}

remove_dkms_module() {
    if [ -e /usr/bin/stop-nvidia-persistenced ] && [ -x /usr/bin/stop-nvidia-persistenced ]; then
        echo "Stopping previous nvidia-persistenced"
        /usr/bin/stop-nvidia-persistenced || true
        echo "Done."
	elif [ -e /lib/systemd/system/nvidia-persistenced.service ]; then
        /bin/systemctl stop --no-block nvidia-persistenced || true
    fi
	echo "Removing all DKMS Modules"
	dkms remove -m $PACKAGE_NAME -v $CVERSION --all > /dev/null
	echo "Done."
}

case "$1" in
	upgrade)
		remove_dkms_module 
	;;
	remove)
		remove_dkms_module 
	
		update-alternatives --remove #DEB_HOST_MULTIARCH#_gl_conf #LDSOCONF#
		update-alternatives --remove #DEB_HOST_MULTIARCH#_egl_conf #LDSOCONF#
		update-alternatives --remove #OTHER_ARCH#_gl_conf #ALTLDSOCONF#
		update-alternatives --remove #OTHER_ARCH#_egl_conf #ALTLDSOCONF#
		# Remove the alternatives for PRIME
		update-alternatives --remove #DEB_HOST_MULTIARCH#_gl_conf #PMLDSOCONF#
		update-alternatives --remove #DEB_HOST_MULTIARCH#_egl_conf #PMLDSOCONF#
		update-alternatives --remove #OTHER_ARCH#_gl_conf #PMALTLDSOCONF#
		update-alternatives --remove #OTHER_ARCH#_egl_conf #PMALTLDSOCONF#
		# Remove the alternative for glamor-egl
		update-alternatives --remove glamor_conf #PKGDATADIR#/glamor.conf

		# explicit ldconfig due to alternatives
		ldconfig

		# Update the grub gfxpayload blacklist
		if which update-grub-gfxpayload >/dev/null 2>&1; then
		    update-grub-gfxpayload
		fi

                # Remove any quirks for the driver
                if [ `which quirks-handler` ]; then
                    quirks-handler -d $PACKAGE_NAME -v
                fi
	;;
esac

#DEBHELPER#
